<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Iron Armor Maker</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --bg:#0b0e14; --fg:#e6edf3; --muted:#9aa4ad; --accent:#74c0fc; }
  body{margin:0;font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--fg)}
  .wrap{max-width:920px;margin:32px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 12px}
  .card{background:#111822;border:1px solid #1b2531;border-radius:12px;padding:16px;margin:12px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  input[type=file]{background:#0f1620;border:1px dashed #2a3748;border-radius:8px;padding:10px;color:var(--muted)}
  button{background:var(--accent);color:#062033;border:0;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:12px}
  .thumb{background:#0f1620;border:1px solid #1b2531;border-radius:10px;padding:10px}
  .thumb img{width:100%;height:auto;display:block;background:transparent}
  .label{font-size:12px;color:var(--muted);margin-top:6px}
  .note{color:var(--muted);font-size:13px}
  .success{color:#8ce99a}
</style>
</head>
<body>
<div class="wrap">
  <h1>Iron Armor Maker</h1>
  <div class="card">
    <div class="row">
      <input id="file" type="file" accept="image/png,image/webp,image/jpeg" />
      <button id="genBtn" disabled>Generate</button>
      <button id="zipBtn" disabled>Download ZIP</button>
    </div>
    <div class="note" style="margin-top:8px">
      Upload your <b>Standard Armor.png</b>. This will recolor to iron and export race-sized overlays (1024×1536 canvas, transparent).
    </div>
  </div>

  <div id="status" class="note"></div>

  <div id="out" class="grid"></div>
</div>

<!-- zipping (client side) -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script>
const fileInput = document.getElementById('file');
const genBtn = document.getElementById('genBtn');
const zipBtn = document.getElementById('zipBtn');
const out = document.getElementById('out');
const statusEl = document.getElementById('status');

const CANVAS_W = 1024, CANVAS_H = 1536;
const RACES = {
  master:      { sx:1.00, sy:1.00, y:0 },
  human:       { sx:1.05, sy:1.05, y:0 },
  elf:         { sx:1.00, sy:1.08, y:-0.01 },
  'half-elf':  { sx:1.05, sy:1.05, y:0 },
  dwarf:       { sx:1.18, sy:0.92, y:0.02 },
  gnome:       { sx:0.92, sy:0.88, y:0.03 },
  halfling:    { sx:0.95, sy:0.90, y:0.02 },
  dragonborn:  { sx:1.22, sy:1.05, y:-0.015 },
  'half-orc':  { sx:1.05, sy:1.05, y:0 },
  tiefling:    { sx:1.00, sy:1.08, y:-0.01 },
};

let results = {}; // {name: dataURL}

fileInput.addEventListener('change', () => {
  genBtn.disabled = !fileInput.files?.length;
  zipBtn.disabled = true;
  out.innerHTML = '';
  results = {};
  statusEl.textContent = '';
});

genBtn.addEventListener('click', async () => {
  const file = fileInput.files?.[0];
  if (!file) return;
  genBtn.disabled = true; zipBtn.disabled = true;
  statusEl.textContent = 'Processing…';

  const img = await readImage(file);
  // assume source is already 1024x1536-ish; we’ll treat it as the “armor body”
  // step 1: make iron tint
  const iron = toIron(img);

  // step 2: generate variants on transparent 1024x1536 canvas
  results = {};
  out.innerHTML = '';
  for (const [name, cfg] of Object.entries(RACES)) {
    const canvas = document.createElement('canvas');
    canvas.width = CANVAS_W; canvas.height = CANVAS_H;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,CANVAS_W,CANVAS_H);

    const nw = Math.max(1, Math.round(iron.width  * cfg.sx));
    const nh = Math.max(1, Math.round(iron.height * cfg.sy));
    const x = Math.round((CANVAS_W - nw)/2);
    const y = Math.round((CANVAS_H - nh)/2 + CANVAS_H * cfg.y);

    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(iron, x, y, nw, nh);

    const url = canvas.toDataURL('image/png');
    results[name] = url;

    addThumb(name, url);
    await tick();
  }

  statusEl.innerHTML = '<span class="success">Done!</span> You can download individual PNGs or click ZIP.';
  genBtn.disabled = false; zipBtn.disabled = false;
});

zipBtn.addEventListener('click', async () => {
  if (!Object.keys(results).length) return;
  zipBtn.disabled = true;
  statusEl.textContent = 'Building ZIP…';

  const zip = new JSZip();
  for (const [name, url] of Object.entries(results)) {
    const bin = dataURLtoUint8Array(url);
    zip.file(`iron_armor_${name}.png`, bin);
  }
  // simple metadata
  const meta = {
    canvas_size: [CANVAS_W, CANVAS_H],
    variants: RACES
  };
  zip.file('iron_armor_variants_meta.json', JSON.stringify(meta, null, 2));

  const blob = await zip.generateAsync({type:'blob'});
  saveAs(blob, 'iron_armor_pack.zip');
  statusEl.innerHTML = '<span class="success">ZIP saved.</span>';
  zipBtn.disabled = false;
});

// ---------- helpers ----------
function readImage(file){
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
    img.onerror = reject;
    img.src = url;
  });
}

function tick(){ return new Promise(r => requestAnimationFrame(r)); }

function addThumb(name, url){
  const div = document.createElement('div');
  div.className = 'thumb';
  div.innerHTML = `
    <img alt="${name}" src="${url}">
    <div class="label">${name}.png —
      <a href="${url}" download="iron_armor_${name}.png">download</a>
    </div>`;
  out.appendChild(div);
}

// Convert DataURL -> Uint8Array for zipping
function dataURLtoUint8Array(dataURL) {
  const base64 = dataURL.split(',')[1];
  const raw = atob(base64);
  const arr = new Uint8Array(raw.length);
  for (let i = 0; i < raw.length; i++) arr[i] = raw.charCodeAt(i);
  return arr;
}

// Canvas “iron” recolor: grayscale + slight contrast/brightness + cool steel tint + gentle radial highlight
function toIron(img){
  // draw original
  const src = document.createElement('canvas');
  src.width = img.naturalWidth; src.height = img.naturalHeight;
  const sctx = src.getContext('2d');
  sctx.drawImage(img, 0, 0);

  // get pixels
  const imgData = sctx.getImageData(0, 0, src.width, src.height);
  const d = imgData.data;

  // grayscale + small contrast/brightness
  // contrast 1.15, brightness +2%
  const contrast = 1.15, brightness = 1.02;
  // steel tint: slightly more blue
  for (let i=0;i<d.length;i+=4){
    const r=d[i], g=d[i+1], b=d[i+2], a=d[i+3];
    // luma
    let y = 0.2126*r + 0.7152*g + 0.0722*b;
    // contrast around 128 and brightness
    y = (y-128)*contrast + 128;
    y *= brightness;
    // clamp
    if (y<0) y=0; else if (y>255) y=255;

    // steel bias
    let R = Math.max(0, Math.min(255, y*0.95));
    let G = Math.max(0, Math.min(255, y));
    let B = Math.max(0, Math.min(255, y*1.05 + 4));

    d[i]=R; d[i+1]=G; d[i+2]=B; d[i+3]=a; // preserve alpha
  }
  sctx.putImageData(imgData, 0, 0);

  // gentle radial highlight (“screen” blend a white gradient)
  const hi = document.createElement('canvas');
  hi.width = src.width; hi.height = src.height;
  const hctx = hi.getContext('2d');

  const cx = src.width/2, cy = src.height*0.25, maxR = Math.min(src.width, src.height)*0.6;
  const grad = hctx.createRadialGradient(cx, cy, 0, cx, cy, maxR);
  grad.addColorStop(0, 'rgba(255,255,255,0.4)');
  grad.addColorStop(1, 'rgba(255,255,255,0)');
  hctx.fillStyle = grad;
  hctx.fillRect(0,0,hi.width,hi.height);

  const out = document.createElement('canvas');
  out.width = src.width; out.height = src.height;
  const octx = out.getContext('2d');
  octx.drawImage(src, 0, 0);
  octx.globalCompositeOperation = 'screen';
  octx.drawImage(hi, 0, 0);
  octx.globalCompositeOperation = 'source-over';

  const ironImg = new Image();
  ironImg.src = out.toDataURL('image/png');
  return ironImg;
}
</script>
</body>
</html>
